name: Sincronizzazione Reale Core (Scenario A)
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync-core:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tuo repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configura Git
        run: |
          git config user.name "GitHub Action Bot"
          git config user.email "action@github.com"

      - name: Preleva codice dal Core Ufficiale
        run: |
          # Usiamo --depth 1 per scaricare solo l'ultimo stato del Core, molto più veloce
          git remote add upstream https://github.com/home-assistant/core.git
          git fetch upstream dev --depth 1
          
          # Creiamo il branch per il confronto
          git checkout -b temp-upstream-compare
          
          # Estraiamo SOLO il file climate.py dal core
          git checkout upstream/dev -- homeassistant/components/tuya/climate.py
          
          # Spostiamolo nella tua cartella custom_components
          mkdir -p custom_components/tuya/
          mv homeassistant/components/tuya/climate.py custom_components/tuya/climate.py
          
          # Pulizia
          rm -rf homeassistant/
          
          git add custom_components/tuya/climate.py
          git commit -m "Aggiornamento ufficiale dal Core del $(date +'%Y-%m-%d')"
          git push origin temp-upstream-compare --force

      - name: Crea Pull Request con Conflitti
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: temp-upstream-compare
          base: main
          title: "⚠️ CONFLITTO RILEVATO: Allineamento Core"
          body: |
            Il file `climate.py` del Core ufficiale è diverso dal tuo.
            Risolvi i conflitti per mantenere il fix