name: Sincronizzazione Reale Core (Forzata)
on:
  workflow_dispatch:

jobs:
  sync-core:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tuo repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configura Git
        run: |
          git config user.name "GitHub Action Bot"
          git config user.email "action@github.com"

      - name: Sincronizzazione Integrale Cartella Tuya
        run: |
          # 1. Aggiungiamo il repository Core come upstream
          git remote add upstream https://github.com/home-assistant/core.git
          
          # 2. Scarichiamo solo i metadati del branch dev (molto veloce con --depth 1)
          git fetch upstream dev --depth 1
          
          # 3. Creiamo/Spostiamoci sul branch di confronto
          git checkout -b temp-upstream-compare || git checkout temp-upstream-compare

          # 4. SOVRASCRIVIAMO tutta la tua cartella locale con quella del Core
          # Questo comando prende TUTTI i file da upstream e li mette nella tua cartella
          git checkout upstream/dev -- homeassistant/components/tuya/
          
          # 5. Spostiamo i file nella posizione corretta del tuo repo (custom_components)
          # Prima puliamo la tua cartella per eliminare file che il Core ha rimosso
          rm -rf custom_components/tuya/*
          cp -r homeassistant/components/tuya/* custom_components/tuya/
          
          # 6. Pulizia cartella temporanea scaricata
          rm -rf homeassistant/

          # 7. Commit di tutto (Git vedr√† cambiamenti in ogni file modificato)
          git add custom_components/tuya/
          git commit -m "üîÑ Sincronizzazione integrale con Home Assistant Core (Tutti i file)"
          git push origin temp-upstream-compare --force

      - name: Crea Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: temp-upstream-compare
          delete-branch: true
          base: main
          title: "‚ö†Ô∏è SINCRONIZZAZIONE TOTALE: Core vs Custom"
          body: |
            Questa PR confronta l'intera cartella `custom_components/tuya/` con la versione ufficiale del Core.
            
            **File controllati:** Tutti i file nella cartella (climate.py, __init__.py, const.py, ecc.)
            
            **Istruzioni per PyCharm:**
            1. Fai `Fetch` da PyCharm.
            2. Confronta il tuo `main` con `origin/temp-upstream-compare`.
            3. Risolvi i conflitti file per file mantenendo i tuoi fix Cecotec.