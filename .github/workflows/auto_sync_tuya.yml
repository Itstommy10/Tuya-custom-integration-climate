name: Sincronizzazione Reale Core (Forzata)
on:
  workflow_dispatch:
jobs:
  sync-core:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tuo repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configura Git
        run: |
          git config user.name "GitHub Action Bot"
          git config user.email "action@github.com"

      - name: Sincronizzazione Integrale Cartella Tuya
        run: |
          # 1. Upstream e Fetch
          git remote add upstream https://github.com/home-assistant/core.git
          git fetch upstream dev --depth 1
          
          # 2. Prepariamo i nuovi file in temp
          mkdir -p /tmp/tuya_core
          git archive upstream/dev homeassistant/components/tuya/ | tar -x -C /tmp/tuya_core
          
          # 3. Pulizia fisica della cartella (NON Git rm)
          # Cancelliamo i file ma non lo diciamo a Git ancora
          rm -rf custom_components/tuya/*
          mkdir -p custom_components/tuya/
          
          # 4. Copiamo solo i file utili (Python, JSON, Markdown)
          # Escludiamo alla radice qualsiasi cosa sia cache
          rsync -av --exclude='__pycache__/' --exclude='*.pyc' /tmp/tuya_core/homeassistant/components/tuya/ custom_components/tuya/
          
          # 5. Verifica finale di sicurezza
          find custom_components/tuya/ -name "__pycache__" -type d -exec rm -rf {} +
          find custom_components/tuya/ -name "*.pyc" -delete
          
          # 6. Pulizia file temporanei
          rm -rf /tmp/tuya_core

      - name: Crea Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: temp-upstream-compare
          delete-branch: true
          base: main
          commit-message: "üîÑ Sincronizzazione integrale con Core (solo sorgenti .py)"
          title: "‚ö†Ô∏è SINCRONIZZAZIONE TOTALE: Core vs Custom"
          body: |
            Questa PR aggiorna tutti i file della cartella `tuya` prelevandoli dal Core ufficiale.
            
            ### üõ† Cosa √® stato fatto:
            - ‚úÖ Scaricati tutti i file `.py`, `.json` e `manifest.json`.
            - ‚ùå Esclusi automaticamente file `.pyc` e cartelle `__pycache__`.
            
            ### üìù Note per il Merge:
            Usa PyCharm per confrontare questa PR con il tuo `main` e reinserire i fix Cecotec dove necessario.