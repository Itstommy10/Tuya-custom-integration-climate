name: Sincronizzazione Reale Core (Forzata)
on:
  workflow_dispatch:

jobs:
  sync-core:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tuo repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configura Git
        run: |
          git config user.name "GitHub Action Bot"
          git config user.email "action@github.com"

      - name: Sincronizzazione Integrale Cartella Tuya
        run: |
          git remote add upstream https://github.com/home-assistant/core.git
          git fetch upstream dev --depth 1
          
          # Creiamo una cartella temporanea esterna per i nuovi file
          mkdir -p /tmp/tuya_core
          git archive upstream/dev homeassistant/components/tuya/ | tar -x -C /tmp/tuya_core
          
          # Torniamo (o restiamo) sul main per permettere a create-pull-request di lavorare
          git checkout main
          
          # Sostituiamo i file nella tua cartella locale
          rm -rf custom_components/tuya/*
          cp -r /tmp/tuya_core/homeassistant/components/tuya/* custom_components/tuya/
          
          # Pulizia
          rm -rf /tmp/tuya_core
          
          # NOTA: NON facciamo il commit qui. 
          # Lasciamo che sia l'azione "create-pull-request" a vedere le modifiche 
          # locali e a creare il branch/commit/PR tutto in un colpo solo.

      - name: Crea Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: temp-upstream-compare
          delete-branch: true
          base: main
          title: "⚠️ SINCRONIZZAZIONE TOTALE: Core vs Custom"
          body: |
            Questa PR confronta l'intera cartella `custom_components/tuya/` con la versione ufficiale del Core.
            
            **File controllati:** Tutti i file nella cartella (climate.py, __init__.py, const.py, ecc.)
            
            **Istruzioni per PyCharm:**
            1. Fai `Fetch` da PyCharm.
            2. Confronta il tuo `main` con `origin/temp-upstream-compare`.
            3. Risolvi i conflitti file per file mantenendo i tuoi fix Cecotec.